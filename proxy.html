<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy Page</title>
</head>

<body>
  <script>
    (function () {
      if (window.parent) {
        var app = window.parent;

        window.addEventListener("message", function (event) {
          if (!event.data) return;
          var data = {};
          try {
            data = JSON.parse(event.data);
          } catch (e) { }

          if (!data.id) return;
          fetch(data.request.url, data.request.options).then(function (response) {
            var headers = {};
            for (var [key, value] of response.headers.entries()) {
              headers[key] = value;
            }
            var message = {
              id: data.id,
              init: {
                status: response.status,
                statusText: response.statusText,
                headers
              }
            };
            response.text().then(function (text) {
              message.body = text;
              app.postMessage(JSON.stringify(message), '*');
            }).catch(function () {
              app.postMessage(JSON.stringify(message), '*');
            });
          });
        }, false);

        app.postMessage('Sp-Proxy-Ready', '*');
      }
    })()
  </script>
</body>

</html>
